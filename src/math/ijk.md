# 四元数笔记

之前有一点复数基础，看了 3Blue1Brown 的四元数理解视频，但是还是没有完全理解四元数是怎么表示旋转的

在小豆发视频后，通过参考一篇知乎文章，加上自己的思考，终于大致理解了四元数的运作，可喜可贺可喜可贺

为此在这里把拼图大致总结一下，以表纪念

## 状态与作用

数字是一个状态，也能表示一个作用。能这么做的前提是有一个用单位作用表示的基准状态，在这里是 `1`

例如，当用一个数字去乘时

`2`表示将`1`放缩为原来的2倍

`-1`表示将`1`反转

`0`表示将`1`长度归零

`1`本身表示什么都不做

一个数的 n次方 表示做这个动作 n 次

0次方 表明做 0 次，也就是什么都不做，所以任意数的 0次方 都是 1

-1次方 是对应操作的逆，可以还原对应操作造成的影响

## 复数

我们定义一个新的作用 $i$, 让 $i^2=-1$

如果 $-1$ 是将 $1$ 反转 180 度，不妨认为，$i$ 的作用是将 $1$ 旋转 90 度

我们不知道这个与实数轴垂直的方向在哪里，但是这不重要

以 $\{1, i\}$ 作为平面直角坐标系的标准正交基，坐标 $(a,b)$ 表示 $a+ib$ 作为一个向量，称为`复平面`

### 复数的线性组合

很显然的，数乘复数对应数乘向量，复数相加对应在复平面内将复数作为向量相加

因此复数可以像向量一样进行线性组合

以基的视角来看有两个互逆运算

- 对一组向量进行系数为 $X$ 的线性组合得到向量 $V$，就是以基下的坐标 $X$ 绘制 $V$
- 分解 $V$ 得到关于一组向量的线性组合系数 $X$，就是求 $V$ 在这个基下的坐标 $X$

当我们考虑一个作用对于全体向量的影响时，只考虑它对基的影响，就能得到它对全体向量的影响，因为全体向量都是基的线性组合

### 旋转90度

$i$ 作用于基 $\{1, i\}$ 时让基逆时针旋转90度，成了 $\{i, -1\}$

因此它对于任意复数的作用是逆时针旋转90度

### 旋转任意角

纯旋转对应在单位圆上的复数 $\cos\theta+i\sin\theta$，它将任意向量逆时针旋转 $\theta$

我们可以用相同的方式理解：

$\cos\theta+i\sin\theta$ 作用于基 $\{1, i\}$，将 1 映射到 $\cos\theta+i\sin\theta$，将 i 映射到 $-\sin\theta+i\cos\theta$。这两个结果正是将原基向量旋转 $\theta$ 后的向量。

由于任何复数都是 1 和 i 的线性组合，因此这个乘法将整个复平面上的点都旋转了 $\theta$。

但是它为什么能让基旋转？我们看看另一个角度

它对基的作用可以分解为 $\cos\theta$ 和 $i\sin\theta$，分别对应当前方向乘 $\cos\theta$ 的放缩和当前方向旋转90度方向上乘 $\sin\theta$ 的放缩，而总影响是它们的组合，也就是旋转

### 任意复数

可以将任意复数 $z$ 的作用分解为放缩和旋转

$$
z=e^{r_z}(\cos\theta_z+i\sin\theta_z)=e^{r_z+i\theta_z}
$$

于是可独立计算放缩和旋转，互不影响

$$
zw=e^{r_z+i\theta_z}e^{r_w+i\theta_w}=e^{(r_z+r_w)+i(\theta_z+\theta_w)}
$$

很容易可以得出复数相乘等于分别计算其长度乘积和旋转之和

## 四元数

复数的定义并没有限定虚数单位是唯一的，可以有许多个方向都与实数轴垂直

但2个方向不能自洽，增加到3个才行

定义

$i^2=j^2=k^2=-1$

满足运算

$\begin{matrix}ij = -ji = k\\ jk = -kj = i\\ ki = -ik = j\end{matrix}$

它不满足乘法交换律，左乘和右乘是不对称的、不可交换的

$\{1,i,j,k\}$ 相互垂直，构成四维空间，$\{i,j,k\}$ 按照右手标架组成三维空间，将实数轴隐藏起来，这是后面我们描述旋转的基础

### 四元数的线性组合

对四元数进行数乘和相加与复数情况类似，这意味着我们能将四元数像向量一样进行线性组合

但由于四元数不遵循交换律，我们接下来考虑作用时默认是左乘

### 旋转90度

由定义很容易看出 $i/j/k$ 对几个基的作用，于是左乘 $i/j/k$ 带来了如下的影响

- 在 $\{1, i/j/k\}$ 平面内的四元数，按照 $1 \rightarrow i/j/k$ 旋转（90 度）
- 在 $ijk$ 空间内与 $i/j/k$ 相垂直平面内的四元数，按照右手定则旋转（90 度）

任意四元数都能投影分解到这两个平面，并受到对应的影响

### 另一个基

显然整个 $ijk$ 空间都与 $1$ 垂直。容易证明，$ijk$ 单位球面上任意一点 $h$ 都有 $h^2=-1$

于是 $h$ 作用于 $\{1, h\}$ 得到 $\{h, -1\}$，左乘 $h$ 带来了如下影响

- 在 $\{1, h\}$ 平面内的四元数，按照 $1 \rightarrow h$ 旋转（90 度）

第二个性质不是那么好证

- 在 $ijk$ 空间内与 $h$ 相垂直平面内的四元数，按照右手定则旋转（90 度）

我们证明一个更大的结论：

$ijk$ 空间内的两个向量相乘，结果可以分解为实数加 $ijk$ 空间内一点：在实数轴上是向量点乘的相反数，在 $ijk$ 空间内是向量叉乘。

$$
\begin{align*}
 &(q_1i+q_2j+q_3k)(u_1i+u_2j+u_3k)\\
=&(q_1iu_1i+q_2ju_2j+q_3ku_3k)\\
 &+(q_2ju_3k+q_3ku_2j)+(q_1iu_3k+q_3ku_1i)+(q_1iu_2j+q_2ju_1i)\\
=&-(q_1u_1+q_2u_2+q_3u_3)\\
 &+i\begin{vmatrix}q_2&q_3\\u_2&u_3\end{vmatrix}-j\begin{vmatrix}q_1&q_3\\u_1&u_3\end{vmatrix}+k\begin{vmatrix}q_1&q_2\\u_1&u_2\end{vmatrix}\\
=&-(q_1u_1+q_2u_2+q_3u_3)+\begin{vmatrix}i&j&k\\q_1&q_2&q_3\\u_1&u_2&u_3\end{vmatrix}
\end{align*}
$$

因此 $h^2=-1$，因为单位向量与自己点乘为 $1$，叉乘为 $0$

$h$ 作用于 $ijk$ 空间内与 $h$ 相垂直平面的基 $\{f, g\}$，得到的点乘为 $0$，叉乘满足右手定则于是旋转90度，证明了结论。

### 旋转任意角

于是我们可以定义单位超球面上的四元数 $\cos\theta+h\sin\theta$

- 在 $\{1, h\}$ 平面内的四元数，按照 $1 \rightarrow h$ 旋转 $\theta$
- 在 $ijk$ 空间内与 $h$ 相垂直平面内的四元数，按照右手定则旋转 $\theta$

任意四元数都能投影分解到这两个平面，并受到对应的影响

表现就是，一方面在 $ijk$ 空间内绕 $h$ 旋转，另一方面关于 $\{1, h\}$ 在虚实之间旋转导致在这个方向上的投影长度可能发生变化，这就是四维双旋转

### 任意四元数

就像任意复数分解到实数轴和虚数轴一样，我们可以将任意四元数分解为标量和向量，即 $q = q_0+hq_h$，其中 $h$ 为方向(单位向量)，$q_h$ 为长度

更一般地，可以将任意复数 $q$ 的作用分解为放缩和旋转

$$
q=e^{r_q}(\cos\theta_q+h\sin\theta_q)
$$

由于数乘和四元数总是可交换的，于是可以将数乘都放到一起计算，这也证明了四元数乘法模长守恒

$$
\begin{align*}
qu=&e^{r_q}(\cos\theta_q+h\sin\theta_q)e^{r_u}(\cos\theta_u+g\sin\theta_u)\\
=&e^{r_q+r_u}(\cos\theta_q+h\sin\theta_q)(\cos\theta_u+g\sin\theta_u)
\end{align*}
$$

### 形象理解

我们已经知道四元数的模长不实际执行旋转，那么只考虑单位超球面，它的维度是3，而可以映射到三维空间内。

关于 $-1$ 作中心投影可以实现这一个目的：让单位球面对应 $ijk$ 空间的单位球面， $1$ 映射到原点，$-1$ 映射到无穷远处，三维空间一点可以表示单位超球面上的任意四元数（$-1$除外）

在这个投影下，离原点的距离与对应四元数旋转角度的大小正相关。原点表示不变，单位球面上的点对应旋转90度，到无穷远点是180度，且关于原点对称的点互为逆

## 四元数旋转

对于四元数表示的旋转，我们要旋转的目标向量是实部为 $0$，在 $ijk$ 空间上的向量 $u$

但我们遇到一个难题：左乘一个单位四元数 q，确实包含了我们想要的旋转，但它是一个“不纯”的四维旋转：它同时改变了向量在实轴和虚空间上的投影（‘双旋转’）。

我们只想旋转三维向量部分，不想改变其实部（保持为0）。如何才能‘纯化’这个旋转，将其效果锁定在三维空间呢？

由 $h$ 的作用可以看出，实数轴上是点乘，满足交换律；而 $ijk$ 空间上是叉乘，交换时反号，这是一个关键的差别

于是，取逆意味着关于原点对称（准确来说是共轭，虚空间反向而实轴不变），而右乘意味着由右手定则变成左手定则

我们可以右乘一个逆，抵消虚实旋转，而二倍空间内旋转，得到了纯的旋转，这就是四元数的旋转公式

$$
quq^{-1}, q=cos\theta+hsin\theta
$$

表示让 $u$ 绕 $h$ 按右手定则旋转 $2\theta$

## 参考资料

- [bilibili - 3Blue1Brown - 四元数的可视化](https://www.bilibili.com/video/BV1SW411y7W1)
- [bilibili - 小豆8593 - 四元数如何控制物体旋转？](https://www.bilibili.com/video/BV14t421h7M4)
- [知乎 - lxycg - 四元数和旋转(Quaternion & rotation)](https://www.zhihu.com/tardis/zm/art/78987582)
